## 규칙7. 종료자 사용을 피하라

### 1. 종료자(finalizer)는 예측 불가능하며, 대체로 위험하고, 일반적으로 불필요하다.
- 소멸자와는 다른 개념(객체에 배정된 자원 반환 - 자바는 GC가 수행)

### 2. 긴급한 작업을 종료자 안에서 처리하면 안된다.
- 어떤 객체에 대한 모든 참조가 사라지고 나서 종료자가 실행되기 까지는 긴 시간이 걸릴 수 도 있다.
  + 파일 닫기와 같은 경우, JVM은 종료자를 천천히 실행하므로 새로운 파일을 열려고 할 경우 파일 개수 제한 오류가 발생할 수 있음.


### 3. 자바 언어 명세서에는 어떤 스레드가 종료자를 실행해야 하는 지 아무 언급이 없다.
- 클래스에 종료자를 붙여놓는 경우, 다른 스레드에 비해 우선순위가 낮을 경우 OutOfMemoryError를 낸 경우도 있다.
- 종료자가 즉시 실행되어야 한다, 반드시 실행되어야 한다는 문구도 없다.
- 지속성이 보장되어야 하는 중요 상태 정보는 종료자로 갱신하면 안된다.
  + 데이터베이스 같은 공유 자원에 지속성 락을 종료자가 반환하게 하면 분산 시스템 전체에 먹통을 줄 수 있다.

### 4. 종료자를 사용하면 프로그램 성능이 심각하게 떨어진다.

### 5. 파일이나 스레드처럼 명시적으로 반환해야 하는 경우, 명시적인 종료 메서드를 정의하라.
- 종료 여부를 객체 안에 두며 / 유효 여부를 판단하는 private 필드를 두어서 / 모든 메서드 맨 앞에서 해당 필드를 검사하라.
- 보통 try-finally 문과 함께 쓰인다.(객체 종료 보장)

```JAVA
Foo foo = new Foo(...);
try {
  //foo로 하는 작업 수행
  ...
} finally {
  foo.terminate(); //명시적 종료 메서드 호출
}
```

### 6. 혹시나 사용하려 하면, 반환할 자원을 발견할 경우 로그로 남겨라.(안전망)
- 클라이언트 코드에 버그가 있는 것이므로, 고치도록 알려야 한다.
- 하지만 정말 구현할 만한 가치가 있는지를 생각 해 보라.

### 7. 네이티브 피어와 연결된 객체를 다룰 땐 적합하다..
- 네이티브 메서드 : 다른 언어로 작성된 코드를 자바에서 호출하도록 만들어진 규약
- 네이티브 피어 : 일반 자바 객체가 네이티브 메서드를 통해 기능 수행을 위임하는 네이티브 객체
  + 네이티브 피어는 일반 객체가 아니므로 자바 피어 객체가 반환될 때 같이 반환할 수 없다.
  + 네이티브 피어가 즉시 종료되어야 하는 자원을 포함하는 경우에는, 종료자를 통해 종료시킨다.

### 8. 종료자 연결이 자동으로 이루어지지 않는다.
- 종료자를 갖고있는 클래스를, 하위 클래스가 해당 메서드를 재정의 하는 경우, 하위 클래스의 상태는 try블록에서 종료 / 상위 클래스 종료자는 finally 블록 안에서 호출해야 한다. -> 그래야만 상위 클래스가 예외를 알아차림

```JAVA
@Override protected void finalize() throws Throwable {
  try {
    ...//자기 자신 (하위 클래스) 종료
  } finally {
    super.finalize(); // 상위 클래스 종료
  }
}
```
- 하위 클래스에서 종료를 잊으면 절대로 상위 클래스가 종료되지 않으므로, 익명 클래스 안에 종료자 정의 하는 방법도 있다.
(종료 보호자 패턴)

```JAVA
public class Foo {
  private final Object finalizerGuardian = new Object() {
    @Override protected void finalize() throws Throwable {
      ... //바깥 Foo 객체를 종료시킴
    }
  };
  ...
}
```

- 위 기법은 종료자가 있는 비-final 클래스를 구현할 때 반드시 고려해야 한다. (상위 클래스인 Foo에는 종료자가 없으므로)

### 9. 결론
- 종료자는 굳이 사용하지 말자
- <del>super.finalize를 호출하자</del>
- <del>종료자가 호출 될 때마다 클라이언트 코드가 잘못 작성되었음을 알리는 메세지를 로그로 남기자</del>
- <del>하위 클래스 정의가 가능한 public 클래스의 경우, 종료 보호자 패턴을 도입하자</del>
